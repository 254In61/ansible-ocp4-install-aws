---
- hosts: localhost

  environment:
    KUBECONFIG: "{{ openshift_build_path }}/auth/kubeconfig"


  tasks:
    - name: create workshop group
      command: "{{ openshift_build_path }}/oc adm groups new workshop"
      ignore_errors: yes

    - name: configure istio service mesh rbac
      k8s:
        state: present
        definition: "{{ lookup('file', './roles/templates/istio-rbac.yaml.j2') }}"

    - name: add users to workshop group
      command: "{{ openshift_build_path }}/oc adm groups add-users workshop user{{ item }}"
      with_sequence: start=1 end="{{ openshift_user_count }}"

    - name: create user projects
      command: "{{ openshift_build_path }}/oc new-project user{{ item }} --as=user{{ item }} --as-group=system:authenticated --as-group=system:authenticated:oauth"
      with_sequence: start=1 end="{{ openshift_user_count }}"
      ignore_errors: yes

    - name: create user ingress gateways
      k8s:
        state: present
        definition: "{{ lookup('template', './roles/templates/ingress-loadbalancer.yaml.j2') }}"
      with_sequence: start=1 end="{{ openshift_user_count }}"

    - name: Install istio servicemesh member roll
      k8s:
        state: present
        definition: "{{ lookup('template', './roles/templates/istio-memberroll.yaml.j2') }}"

    - name: pausing 150 seconds to allow the service mesh to start
      pause:
        seconds: 150

    - name: remove DeploymentConfig exclusion from kiali configmap
      shell: "{{ openshift_build_path }}/oc get cm/kiali --namespace istio-system --output yaml | grep --invert-match DeploymentConfig | oc apply -f -"

    - name: Make sure the operators are all installed
      command: "{{ openshift_build_path }}/oc rollout restart deployment kiali --namespace istio-system"

    - name: Create istio user operatorgroups
      k8s:
        state: present
        definition: "{{ lookup('template', './roles/templates/istio_create_user_operatorgroup.yaml.j2') }}"
      with_sequence: start=1 end="{{ openshift_user_count }}"

    - name: Install keycloak operator into each user's project
      k8s:
        state: present
        definition: "{{ lookup('template', './roles/templates/keycloak_user_install.yaml.j2') }}"
      with_sequence: start=1 end="{{ openshift_user_count }}"
